name: Test cron env on multiple OSes via Docker

on:
  workflow_dispatch:

jobs:
  cron-docker:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    strategy:
      matrix:
        image:
          - ubuntu:22.04
          - debian:bullseye
          - alpine:3.18
          - centos:7
          - centos:stream9
    name: ${{ matrix.image }}
    
    steps:
      - name: Checkout (dummy)
        uses: actions/checkout@v4

      - name: Run container and extract cron env
        run: |
          set -eux
          IMAGE=${{ matrix.image }}
          CONTAINER=cron-test

          # 作業用スクリプトを作成
          cat <<'EOF' > setup-cron.sh
          #!/bin/sh
          set -eux
          # 各種パッケージマネージャーに応じてcronをインストール
          if command -v apt-get >/dev/null 2>&1; then
            apt-get update && apt-get install -y cron
          elif command -v apk >/dev/null 2>&1; then
            apk update && apk add --no-cache dcron
          elif command -v yum >/dev/null 2>&1; then
            yum install -y cronie
          fi

          # ユーザーのcrontabにcronジョブを登録
          echo "* * * * * env > /host/hoge.txt" | crontab -

          # cronデーモンをバックグラウンドで起動
          if command -v crond >/dev/null 2>&1; then
            crond -l 2 -f &
          else
            service cron start
          fi

          # 次の0秒がくるまで待機
          sleep 61
          CURRENT_SEC=$(date +%S)
          DIFF=$((60 - 10#$CURRENT_SEC))
          TOTAL_WAIT=$(( (DIFF == 0 ? 60 : DIFF) + 5 ))
          echo "Current seconds: $CURRENT_SEC. Waiting $TOTAL_WAIT seconds until the next cron trigger..."
          sleep $TOTAL_WAIT
          EOF

          chmod +x setup-cron.sh

          # Dockerコンテナを起動：ホスト側のカレントディレクトリを /host にマウント
          docker run --rm -v "$PWD":/host --name $CONTAINER $IMAGE /host/setup-cron.sh

      - name: Show env from cron
        run: |
          echo "::group::Dump cron env output from ${{ matrix.image }}"
          cat ./tmp/hoge.txt || echo "env not found"
          echo "::endgroup::"
